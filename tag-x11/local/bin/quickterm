#!/bin/sh
# shellcheck disable=SC2039

cmd=${1:-$SHELL}
name=quickterm-$(basename "$cmd")

WIDTH=120
HEIGHT=36

# check for a running quickterm
if id=$(xdotool search --classname "$name"); then
  if [ "$id" = "$(xdotool getactivewindow)" ]; then
    # quickterm is running and active; hide it
    xdotool windowunmap "$id"
  else
    # quickterm is running and hidden; show it
    xdotool windowmap "$id"
    xdotool windowraise "$id"
  fi
else
  # prevent tmux spawns in child shells
  export TMUX=

  # no quickterm; spawn a new one
  case "$TERMINAL" in
    alacritty)
      alacritty --class "$name" --dimensions "$WIDTH" "$HEIGHT" --command "$cmd" &
      ;;
    *)
      "$TERMINAL" -name "$name" -geometry "${WIDTH}x${HEIGHT}" -e "$cmd" &
      ;;
  esac
fi

(
  sleep 0.5
  # loop until the quickterm exits
  while id=$(xdotool search --classname "$name"); do
    # if focus is lost, hide and exit
    if [ ! "$id" = "$(xdotool getactivewindow)" ]; then
      xdotool windowunmap "$id"
      exit
    fi
    # be at least a little graceful
    sleep 0.2
  done
) &
