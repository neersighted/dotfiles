#!/bin/sh
# shellcheck disable=SC2039

cmd=${1:-$SHELL}
name=quickterm-$(basename "$cmd")

WIDTH=120
HEIGHT=36

# Check if quickterm already is running.
if id=$(xdotool search --classname "$name"); then
  if [ "$id" = "$(xdotool getactivewindow)" ]; then
    # A quickterm is running and active, hide it.
    xdotool windowunmap "$id"
  else
    # A quickterm is running and hidden, show it.
    xdotool windowmap "$id"
    xdotool windowraise "$id"
  fi
else
  export QUICKTERM=1
  case "$TERMINAL" in
    alacritty)
      alacritty --class "$name" -d "$WIDTH" "$HEIGHT" -e "$cmd" &
      ;;
    *)
      "$TERMINAL" -name "$name" -geometry "${WIDTH}x${HEIGHT}" -e "$cmd" &
      ;;
  esac
fi

(
  # Loop until quickterm exits or we lose focus.
  while id=$(xdotool search --classname "$name"); do
    if [ ! "$id" = "$(xdotool getactivewindow)" ]; then
      # Hide quickterm on focus lost, then exit.
      xdotool windowunmap "$id"
      exit
    fi
    sleep 0.1
  done
) &
