#!/bin/sh

set -e

print() {
  # cyan
  printf '\033[0;34m%s\033[0m\n' "$@"
}

if [ -n "$1" ]; then
  command=$1
  shift
fi

DOTFILES=${DOTFILES:-~/.local/share/chezmoi}
REPO=${REPO:-https://github.com/neersighted/dotfiles.git}

case ${command:-apply} in
  apply | update | sync)
    if [ ! "$INNER" ]; then
      if ! command -v chezmoi >/dev/null; then
        CHEZMOI="$HOME/.local/bin/chezmoi"
        print "Bootstrapping chezmoi..."
        curl -sSfL https://git.io/chezmoi | sed 's/openssl -dst //' | sh -s -- -b ~/.local/bin
      else
        CHEZMOI=chezmoi
      fi

      print "Applying dotfiles with chezmoi..."
      if [ -d "$DOTFILES" ]; then
        if [ -z "$(git -C "$DOTFILES" status --untracked-files=no --porcelain)" ]; then
          $CHEZMOI update --remove
        else
          $CHEZMOI apply --remove
        fi
      else
        $CHEZMOI init --apply "$REPO"
      fi

      CMD=$0
      if [ -z "$0" ]; then
        CMD="$HOME/.local/bin/rep"
      fi

      export INNER=1
      exec "$CMD" apply
    fi

    # shellcheck source=../share/replicator/_lib.sh
    . "${XDG_DATA_HOME:-$HOME/.local/share}/replicator/_lib.sh"

    for script in "$XDG_DATA_HOME/replicator"/*; do
      case "$script" in */_lib.sh) continue ;; esac
      [ -x "$script" ] && "$script"
    done

    if [ "$(dirname "$(command -v chezmoi)")" = "$HOME/.local/bin" ]; then
      # shellcheck disable=SC2230
      if [ "$(which -a chezmoi | wc -l)" -gt 1 ]; then
        rm "$HOME/.local/bin/chezmoi"
      else
        print "Self-updating chezmoi..."
        "$HOME/.local/bin/chezmoi" upgrade
      fi
    fi
    ;;
  commit)
    if [ -z "$*" ]; then
      git -C "$DOTFILES" commit --interactive
    else
      git -C "$DOTFILES" commit "$@"
    fi
    ;;
  diff)
    chezmoi diff
    ;;
  push | pull)
    git -C "$DOTFILES" "$command" "$@"
    ;;
  shfmt)
    for script in $(shfmt -f "$DOTFILES"); do
      shfmt -p -i 2 -bn -ci -s -w "$script"
    done
    ;;
  status)
    git -C "$DOTFILES" status
    chezmoi diff
    ;;
  *)
    printf 'unknown command: %s' "$command"
    ;;
esac
