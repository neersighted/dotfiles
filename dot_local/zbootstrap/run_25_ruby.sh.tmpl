#!/bin/sh

set -e

# shellcheck source=lib.sh
. "{{ .chezmoi.sourceDir }}/dot_local/zbootstrap/lib.sh"

section "Ruby"

git_sync https://github.com/rbenv/rbenv "$RBENV_ROOT"
git_sync https://github.com/rbenv/ruby-build "$RBENV_ROOT/plugins/ruby-build"
git_sync https://github.com/rbenv/rbenv-default-gems "$RBENV_ROOT/plugins/rbenv-default-gems"

if ! make -C "$RBENV_ROOT/src" -q; then
  sh -c "cd $RBENV_ROOT; ./src/configure"
  make -C "$RBENV_ROOT/src"
fi

RUBY_VERSION=$(rbenv install -l | selectversion)
if ! rbenv versions --bare | grep -Fxq "$RUBY_VERSION"; then
  important "Installing Ruby $RUBY_VERSION..."
  rbenv install -s "$RUBY_VERSION"
  important "Activating Ruby $RUBY_VERSION..."
  rbenv global "$RUBY_VERSION"
fi

important "Updating gems..."
for ruby in $(rbenv versions --bare); do
  info "Updating RubyGems ($ruby)..."
  RBENV_VERSION=$ruby gem update --system
  for target in $(RUBY_VERSION=$ruby gem outdated | cut -d' ' -f1); do
    info "Updating $target ($ruby)..."
    RUBY_VERSION=$ruby gem update "$target"
  done
done

# vi: ft=sh
