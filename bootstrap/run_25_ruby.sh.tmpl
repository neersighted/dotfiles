#!/bin/sh

set -e

# shellcheck source=lib.sh
. "{{ .chezmoi.sourceDir }}/bootstrap//lib.sh"

section "Ruby"

git_sync https://github.com/rbenv/rbenv "$RBENV_ROOT"
git_sync https://github.com/rbenv/ruby-build "$RBENV_ROOT/plugins/ruby-build"
git_sync https://github.com/aripollak/rbenv-bundler-ruby-version "$RBENV_ROOT/plugins/rbenv-bundler-ruby-version"
git_sync https://github.com/tpope/rbenv-communal-gems "$RBENV_ROOT/plugins/rbenv-communal-gems"
git_sync https://github.com/rbenv/rbenv-default-gems "$RBENV_ROOT/plugins/rbenv-default-gems"
git_sync https://github.com/rbenv/rbenv-each "$RBENV_ROOT/plugins/rbenv-each"

# XXX: ugly hack to work around limitations of chezmoi/rbenv-default-gems
cp -f "{{ .chezmoi.sourceDir }}/dot_local/share/rbenv/default-gems" "$RBENV_ROOT/default-gems"

(
  cd "$RBENV_ROOT" || exit 1
  src/configure
  make -C src
)

RUBY_VERSION=$(rbenv install -l | selectversion)
RBENV_INSTALLED=$(rbenv versions --bare)

if ! echo "$RBENV_INSTALLED" | grep -Fxq "$RUBY_VERSION"; then
  info "Installing Ruby $RUBY_VERSION..."
  rbenv install -s "$RUBY_VERSION"
  info "Activating Ruby $RUBY_VERSION..."
  rbenv global "$RUBY_VERSION"
fi

info "Updating gems..."
rbenv each gem update --system
rbenv each gem update

# vi: ft=sh
