#!/bin/sh
# shellcheck disable=SC2039

set -e

section() {
  printf "\\n\\033[0;34m%s\\033[0m\\n" "$@"
}

endsection() {
  :
}

info() {
  printf "\\033[0;32m%s\\033[0m\\n" "$@"
}

important() {
  printf "\\033[0;35m%s\\033[0m\\n" "$@"
}

error() {
  printf "\\033[0;31m%s\\033[0m\\n" "$@"
  exit 1
}

getshell() {
  local shell
  if command -v dscacheutil >/dev/null; then
    shell=$(dscacheutil -q user -a name "$USER" | grep shell | cut -d: -f2)
  else
    shell=$(getent passwd "$USER" | awk -F: '{print $NF}')
  fi

  basename "$shell"
}

latestversion() {
 awk -F '.' '
  /^[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+[[:space:]]*$/ {
    This = ($1 * 100 + $2) * 100 + $3
    if ( This > Max ) {
      Max = This
      Version = $0
    }
  }
  END {
    gsub(/^[ \t]+/, "", Version)
    print Version
  }'
}


important "Bootstrapping environment..."

#
# System
#

section "Packages"
  if command -v apt-get >/dev/null; then
    bld="autoconf bison build-essential ccache clang cmake pkgconf"
    lib="libbz2-dev libffi-dev libgdbm-dev libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev libssl-dev libyaml-dev zlib1g-dev"
    usr="exuberant-ctags fish gdb gnupg htop lftp mosh neovim shellcheck socat tig tmux unzip vim whois"

    info "Installing packages with apt..."
    sudo sh -c "apt-get install -y $bld $lib $usr"
  elif command -v pkg >/dev/null; then
    bld="ccache cmake gcc gmake pkgconf"
    lib="libssh2 openssl sqlite3"
    usr="bash coreutils curl fish gdb gnupg htop lftp mosh neovim pinentry-curses hs-shellcheck socat tig tmux universal-ctags unzip vim whois"

    info "Installing packages with pkg..."
    su root -c "pkg install -y $bld $lib $usr"
  elif command -v brew >/dev/null; then
    bld="ccache cmake"
    lib="libedit zlib"
    usr="coreutils ctags fish gdb gnupg htop lftp mosh neovim pinentry-mac reattach-to-user-namespace shellcheck socat tmux unzip vim"

    info "Installing packages with brew..."
    sh -c "brew install $bld $lib $usr"
  else
    error "No package manager found. Is this a supported system?"
  fi
endsection

#
# Environment
#

section "Golang"
  GOENV_ROOT="$HOME/.goenv"

  if [ ! -d "$GOENV_ROOT" ]; then
    info "Installing goenv..."
    git clone https://github.com/syndbg/goenv "$GOENV_ROOT"
  else
    info "Updating goenv..."
    git -C "$GOENV_ROOT" pull
  fi

  export PATH="$GOENV_ROOT/bin:$PATH"
  eval "$(goenv init -)"

  GO_LATEST=$(goenv install -l | latestversion)
  if [ "$(goenv global)" != "$GO_LATEST" ]; then
    info "Setting up latest version of Golang..."
    goenv install -s "$GO_LATEST"
    goenv global "$GO_LATEST"
  fi

  if [ -z "$GOPATH" ]; then
    export GOPATH="$HOME/.local/go"
  fi

  install_go_tool() {
    local target="$1"

    info "Installing/updating $target using go get..."
    go get -u "$target"
  }

  install_go_tool "golang.org/x/lint/golint"
  install_go_tool "github.com/nsf/gocode"
  install_go_tool "github.com/sourcegraph/go-langserver"
endsection


section "Node.js"
  NODENV_ROOT="$HOME/.nodenv"

  if [ ! -d "$NODENV_ROOT" ]; then
    info "Installing nodenv..."
    git clone https://github.com/nodenv/nodenv "$NODENV_ROOT"
    git clone https://github.com/nodenv/node-build "$NODENV_ROOT/plugins/node-build"
  else
    info "Updating nodenv..."
    git -C "$NODENV_ROOT" pull
    git -C "$NODENV_ROOT/plugins/node-build" pull
  fi

  export PATH="$NODENV_ROOT/bin:$PATH"
  eval "$(nodenv init -)"

  NODE_LATEST=$(nodenv install -l | latestversion)
  if [ "$(nodenv global)" != "$NODE_LATEST" ]; then
    info "Setting up latest version of Node.js..."
    nodenv install -s "$NODE_LATEST"
    nodenv global "$NODE_LATEST"
  fi

  install_npm_tool() {
    local target="$1"

    info "Installing/updating $target using npm..."
    npm install -g "$target"
  }

  install_npm_tool "flow-language-server"
  install_npm_tool "pnpm"
  install_npm_tool "yarn"
endsection


section "Python"
  PYENV_ROOT="$HOME/.pyenv"

  if [ ! -d "$PYENV_ROOT" ]; then
    info "Installing pyenv..."
    git clone https://github.com/pyenv/pyenv "$PYENV_ROOT"
  else
    info "Updating pyenv..."
    git -C "$PYENV_ROOT" pull
  fi

  export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(pyenv init -)"

  PYTHON_LATEST=$(pyenv install -l | latestversion)
  if [ "$(pyenv global)" != "$PYTHON_LATEST" ]; then
    info "Setting up latest version of Python..."
    pyenv install -s "$PYTHON_LATEST"
    pyenv global "$PYTHON_LATEST"
  fi

  if [ -z "$PIPX_HOME" ]; then
    export PIPX_HOME="$HOME/.local/pipx/venvs"
  fi
  if [ -z "$PIPX_BIN_DIR" ]; then
    export PIPX_BIN_DIR="$HOME/.local/pipx/bin"
  fi

  if ! command -v pipx; then
    info "Installing pipx..."
    mkdir -p "$PIPX_BIN_DIR/.." # FIXME: cs01/pipx#9
    curl https://raw.githubusercontent.com/cs01/pipx/master/get-pipx.py -fsSL | python3 - --no-modify-path

    export PATH="$PIPX_BIN_DIR:$PATH"
  else
    info "Upgrading pipx..."
    pipx upgrade pipx
  fi

  install_python_tool() {
    local target="$1"
    shift
    local additional_targets="$*"

    if ! pipx list | grep -F "$target" >/dev/null; then
      info "Installing $target using pipx..."
      pipx install "$target"
    else
      info "Updating $target using pipx..."
      pipx upgrade "$target"
    fi

    if [ -n "$additional_targets" ]; then
      info "Installing/updating $additional_targets in $target environment..."
      for atarget in $additional_targets; do
        "$PIPX_HOME/$target/bin/pip" install -U "$atarget"
      done
    fi
  }

  #install_python_tool "autopep8"
  install_python_tool "black"
  install_python_tool "flake8"
  install_python_tool "mypy"
  install_python_tool "pipenv"
  #install_python_tool "pylint"
  #install_python_tool "python-language-server" "autopep8" "mccabe" "pycodestyle" "pydocstyle" "pyflakes" "rope" "yapf"
endsection


section "Ruby"
  RBENV_ROOT="$HOME/.rbenv"

  if [ ! -d "$RBENV_ROOT" ]; then
    info "Installing rbenv..."
    git clone https://github.com/rbenv/rbenv "$RBENV_ROOT"
    git clone https://github.com/rbenv/ruby-build "$RBENV_ROOT/plugins/ruby-build"
  else
    info "Updating rbenv..."
    git -C "$RBENV_ROOT" pull
    git -C "$RBENV_ROOT/plugins/ruby-build" pull
  fi

  export PATH="$RBENV_ROOT/bin:$PATH"
  eval "$(rbenv init -)"

  RUBY_LATEST="$(rbenv install -l | latestversion)"
  if [ "$(rbenv global)" != "$RUBY_LATEST" ]; then
    info "Setting up latest version of Ruby..."
    rbenv install -s "$RUBY_LATEST"
    rbenv global "$RUBY_LATEST"
  fi
endsection


section "Rust"
  if ! command -v rustup >/dev/null; then
    info "Setting up Rust toolchain..."
    curl https://sh.rustup.rs -fsSL | sh -s -- -y --no-modify-path --default-toolchain nightly

    export PATH="$HOME/.cargo/bin:$PATH"
    rustup component add rust-src rust-analysis rls-preview clippy-preview rustfmt-preview llvm-tools-preview
  else
    info "Updating Rust toolchain..."
    rustup self update
    rustup update
  fi

  install_rust_tool() {
    local target="$1"
    local git="$2"

    (
      CARGO_BUILD_TARGET_DIR=$(mktemp -d "${TMPDIR:-/tmp}/cargo.XXXXXXXXX")
      export CARGO_BUILD_TARGET_DIR

      trap '{ rm -rf "$CARGO_BUILD_TARGET_DIR"; }' EXIT

      if cargo install --list | grep -Eq "^$target"; then
        info "Updating $target using cargo install-update..."
        cargo install-update ${git:+-g} "$target"
      else
        info "Installing $target using cargo install..."
        cargo install "$target" ${git:+--git "$git"}
      fi

      if [ -d "$CARGO_BUILD_TARGET_DIR/release/build" ]; then
        local completion
        completion=$(find "$CARGO_BUILD_TARGET_DIR/release/build" -name '*.fish')
        if [ -n "$completion" ]; then
          info "Installing fish completion for $target..."
          cp "$completion" "$HOME/.config/fish/completions"
        fi
      fi
    )
  }

  install_rust_tool "cargo-binutils"
  install_rust_tool "cargo-bloat"
  install_rust_tool "cargo-expand"
  install_rust_tool "cargo-outdated"
  install_rust_tool "cargo-tree"
  install_rust_tool "cargo-update"
  install_rust_tool "cargo-watch"
  install_rust_tool "racer"
endsection


#
# Tools
#

section "fish"
  if [ ! "$(getshell)" = 'fish' ]; then
    info "Changing login shell to fish..."

    shell=$(command -v fish)
    if [ "$(uname)" = 'FreeBSD' ]; then
      su root -c "chsh -s $USER $shell"
    else
      sudo chsh -s "$shell" "$USER"
    fi
  fi

  if [ ! -e "$HOME/.config/fish/functions/fisher.fish" ]; then
    info "Bootstrapping fisher..."
    curl https://git.io/fisher -fsSLo "$HOME/.config/fish/functions/fisher.fish"
  fi

  info "Installing fish plugins using fisher..."
  fish -c fisher
endsection


section "Vim"
  if ! command -v neovim-node-host >/dev/null; then
    info "Installing Node.js Neovim provider..."
    npm install -g neovim
  fi
  if ! python2 -c "import neovim" 2>/dev/null; then
    info "Installing Python 2 Neovim provider..."
    python2 -m pip install -U neovim
  fi
  if ! python3 -c "import neovim" 2>/dev/null; then
    info "Installing Python 3 Neovim provider..."
    python3 -m pip install -U neovim
  fi
  if ! command -v neovim-ruby-host >/dev/null; then
    info "Installing Ruby Neovim provider..."
    gem install neovim
  fi

  install_python_tool "neovim-remote"
  install_python_tool "vim-vint"
  install_rust_tool "pack" "https://github.com/maralla/pack"

  if ! [ -e "$HOME/.vim/pack" ];  then
    info "Bootstrapping Vim plugins using pack install..."
    pack install
  fi
endsection


section "CLI"
  install_go_tool "github.com/github/hub"
  install_go_tool "github.com/junegunn/fzf"
  install_go_tool "github.com/nishanths/license"
  install_go_tool "github.com/simeji/jid/cmd/jid"
  install_go_tool "mvdan.cc/xurls/cmd/xurls"
  install_npm_tool "diff-so-fancy"
  install_npm_tool "git-open"
  #install_python_tool "asciinema"
  install_python_tool "gdbgui"
  install_python_tool "legit"
  install_rust_tool "exa"
  install_rust_tool "fd-find"
  install_rust_tool "hyperfine"
  install_rust_tool "ripgrep"
  install_rust_tool "tokei"

  info "Installing/updating gdb-dashboard..."
  curl https://raw.githubusercontent.com/cyrus-and/gdb-dashboard/master/.gdbinit -fsSLo "$HOME/.gdbinit"

  info "Installing/updating fzf-tmux..."
  curl https://raw.githubusercontent.com/junegunn/fzf/master/bin/fzf-tmux -fsSLo "$HOME/.local/bin/fzf-tmux"
  chmod +x "$HOME/.local/bin/fzf-tmux"
endsection

important "Done! Restart your shell!"
