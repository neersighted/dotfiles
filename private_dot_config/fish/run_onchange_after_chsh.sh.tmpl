{{- if lookPath "fish" -}}
#!/bin/sh -e

username={{ .chezmoi.username | quote }}
getshell() {
  {{- if eq .chezmoi.os "darwin" }}
  dscl . read "/Users/$username" UserShell | awk '{print $2}'
  {{ else }}
  getent passwd "$username" | awk -F: '{print $7}'
  {{- end }}
}
setshell() { # shell
  {{- if eq .chezmoi.os "darwin" }}
  sudo dscl . create "/Users/$username" UserShell "$1"
  {{ else if eq .chezmoi.os "freebsd" }}
  su root -c "pw usermod -n '$username' -s '$1'"
  {{ else }}
  sudo usermod -s "$1" "$username"
  {{- end }}
}

fish={{ lookPath "fish" | quote }}
if [ "$(getshell)" != "$fish" ]; then
  if ! grep -Fxq "$fish" /etc/shells; then
    echo "Adding $fish to /etc/shells..."
    printf '%s\n' "$fish" | sudo tee -a /etc/shells
  fi

  echo "Changing login shell to fish..."
  setshell "$fish"
fi

# vi: ft=sh
{{- end -}}
