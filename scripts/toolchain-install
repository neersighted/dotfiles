#!/usr/bin/make -f

unexport MAKEFLAGS

TOOLCHAINS = node python ruby rust
TOOLS = fish fd fzf neovim pretty-git-prompt ripgrep


help:
	@echo "TARGETS: $(TARGETS)"
	@echo "AVAILABLE TOOLCHAINS: $(TOOLCHAINS)"
	@echo "AVAILABLE TOOLS: $(TOOLS)"

toolchains: $(TOOLCHAINS)
tools: $(TOOLS)
all: toolchains tools

.PHONY: $(TOOLCHAINS) $(TOOLS) toolchains tools all help

#
# Toolchains
#

# Go
%.go:
	go get -u github.com/$*


# Node.js
NVM_ROOT = $(HOME)/.nvm
NVM = $(NVM_ROOT)/nvm.sh
$(NVM):
	git -C $(NVM_ROOT) pull || git clone https://github.com/creationix/nvm $(NVM_ROOT)

NODE_VERSION = v9.11.1
NODE_ROOT = $(NVM_ROOT)/versions/node/$(NODE_VERSION)
NODE = $(NODE_ROOT)/bin/node
$(NODE): $(NVM)
	bash -c ". $(NVM) && nvm install $(NODE_VERSION)"
	bash -c ". $(NVM) && nvm alias default $(NODE_VERSION)"

NPM = $(NODE_ROOT)/bin/npm
$(NPM): $(NODE)

%.js: $(NPM)
	$(NODE) $(NPM) install -g $*

node: $(NPM) yarn.js pnpm.js


# Python
PYENV_ROOT = $(HOME)/.pyenv
PYENV = $(PYENV_ROOT)/bin/pyenv
$(PYENV):
	git -C $(PYENV_ROOT) pull || git clone https://github.com/pyenv/pyenv $(PYENV_ROOT)

PYENV_PLUGIN = $(PYENV_ROOT)/plugins/$(shell basename $@)
pyenv-%: $(PYENV)
	git -C $(PYENV_PLUGIN) pull || git clone https://github.com/$@ $(PYENV_PLUGIN)

pyenv: $(PYENV) pyenv/pyenv-ccache pyenv/pyenv-doctor pyenv/pyenv-installer \
	pyenv/pyenv-pip-migrate massongit/pyenv-pip-update pyenv/pyenv-update

PYTHON3_VERSION = 3.6.5
PYTHON3 = $(PYENV_ROOT)/versions/$(PYTHON3_VERSION)/bin/python
$(PYTHON3): pyenv
	$(PYENV) install -s $(PYTHON3_VERSION)

PIP3 = $(PYENV_ROOT)/versions/$(PYTHON3_VERSION)/bin/pip3
$(PIP3): $(PYTHON3)

%.py3: $(PIP3)
	$(PIP3) install -U $*
	$(PYENV) rehash

PYTHON2_VERSION = 2.7.14
PYTHON2 = $(PYENV_ROOT)/versions/$(PYTHON2_VERSION)/bin/python
$(PYTHON2): pyenv
	$(PYENV) install -s $(PYTHON2_VERSION)

PIP2 = $(PYENV_ROOT)/versions/$(PYTHON2_VERSION)/bin/pip2
$(PIP2): $(PYTHON2)

%.py2: $(PIP2)
	$(PIP2) install -U $*
	$(PYENV) rehash

PIPSI = $(HOME)/.local/bin/pipsi
$(PIPSI): $(PYTHON3)
	curl http://git.io/get-pipsi -fsSL | $(PYTHON3) - --src=git+https://github.com/mitsuhiko/pipsi.git

%.pipsi: $(PIPSI)
	$(PIPSI) install $* || $(PIPSI) upgrade $*

python: $(PIP2) $(PIP3) $(PIPSI) pylint.pipsi flake8.pipsi mypy.pipsi pipenv.pipsi
	$(PYENV) global $(PYTHON3_VERSION) $(PYTHON2_VERSION)


# Ruby
RBENV_ROOT = $(HOME)/.rbenv
RBENV = $(RBENV_ROOT)/bin/rbenv
$(RBENV):
	git -C $(RBENV_ROOT) pull || git clone https://github.com/rbenv/rbenv $(RBENV_ROOT)
	git -C $(RBENV_ROOT)/plugins/ruby-build pull || git clone https://github.com/rbenv/ruby-build $(RBENV_ROOT)/plugins/ruby-build

RBENV_PLUGIN = $(RBENV_ROOT)/plugins/$(shell basename $@)
rbenv-%: $(RBENV)
	git -C $(RBENV_PLUGIN) pull || git clone https://github.com/$@ $(RBENV_PLUGIN)

rbenv: $(RBENV) ianheggie/rbenv-binstubs yyuu/rbenv-ccache rbenv/rbenv-each \
	ianheggie/rbenv-env rbenv/rbenv-installer rkh/rbenv-update

RUBY_VERSION = 2.5.1
RUBY = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/ruby
$(RUBY): rbenv
	$(RBENV) install -s $(RUBY_VERSION)

GEM = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/gem
$(GEM): $(RUBY)

%.gem: $(GEM)
	$(GEM) install $*
	$(RBENV) rehash

ruby: $(GEM) bundler.gem rubocop.gem reek.gem
	$(RBENV) global $(RUBY_VERSION)


# Rust
CARGO_ROOT = $(HOME)/.cargo
RUSTUP = $(CARGO_ROOT)/bin/rustup
$(RUSTUP):
	curl https://sh.rustup.rs -fsSL | sh -s -- -y --no-modify-path --default-toolchain nightly
	$(RUSTUP) component add rustfmt-preview rls-preview

CARGO = $(CARGO_ROOT)/bin/cargo
$(CARGO): $(RUSTUP)

%.rs: $(CARGO)
	$(CARGO) install-update -i $* || $(CARGO) install $*

rust: $(CARGO) cargo-update.rs cargo-watch.rs clippy.rs


#
# Tools
#

# fish (fisherman)
FISH_CONFIG = $(HOME)/.config/fish
FISHER = $(FISH_CONFIG)/functions/fisher.fish
$(FISHER):
	curl https://git.io/fisher -fsSLo $(FISHER)

%.fisher:
	fish -c "fisher $*"

fish: $(FISHER) oh-my-fish/plugin-bang-bang.fisher brigand/fast-nvm-fish.fisher \
	fisherman/fzf.fisher fisherman/pipenv.fisher \
	neersighted/pyenv@patch-1.fisher neersighted/rbenv@patch-1.fisher \
	oh-my-fish/plugin-sudope.fisher fisherman/z.fisher


# fd
fd: fd-find.rs


# fzf
fzf: junegunn/fzf.go


# neovim (rplugin providers)
NEOVIM_CONFIG = $(HOME)/.config/nvim/local.vim
$(NEOVIM_CONFIG): $(NEOVIMPY2) $(NEOVIMPY3)
	echo "let g:python3_host_prog = '$(PYTHON3)'" > $(NEOVIM_CONFIG)
	echo "let g:python_host_prog = '$(PYTHON2)'" >> $(NEOVIM_CONFIG)

neovim: neovim.js neovim.py2 neovim.py3 neovim.gem $(NEOVIM_CONFIG)


# pretty-git-prompt
pretty-git-prompt: pretty-git-prompt.rs


# ripgrep
ripgrep: ripgrep.rs
