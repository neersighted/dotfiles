#!/usr/bin/make -f

unexport MAKEFLAGS

TOOLCHAINS = node python ruby rust
TOOLS = fish fzf neovim ripgrep


help:
	@echo "TARGETS: $(TARGETS)"
	@echo "AVAILABLE TOOLCHAINS: $(TOOLCHAINS)"
	@echo "AVAILABLE TOOLS: $(TOOLS)"

toolchains: $(TOOLCHAINS)
tools: $(TOOLS)
all: toolchains tools

.PHONY: $(TOOLCHAINS) $(TOOLS) toolchains tools all help

#
# Toolchains
#


# Node.js
NVM_ROOT = $(HOME)/.nvm
NVM = $(NVM_ROOT)/nvm.sh
$(NVM):
	git -C $(NVM_ROOT) pull || git clone https://github.com/creationix/nvm $(NVM_ROOT)

NVM_SHIM = $(HOME)/.local/bin/$*
%.nvmshim:
	echo '#! /usr/bin/env fish\n__nvm_run "$*" $$argv' > $(NVM_SHIM)
	chmod +x $(NVM_SHIM)


NODE_VERSION = v9.11.1
NODE_ROOT = $(NVM_ROOT)/versions/node/$(NODE_VERSION)
NODE = $(NODE_ROOT)/bin/node
$(NODE): $(NVM)
	bash -c ". $(NVM) && nvm install $(NODE_VERSION)"
	bash -c ". $(NVM) && nvm alias default $(NODE_VERSION)"

NPM = $(NODE_ROOT)/bin/npm
$(NPM): $(NODE)

%.js: $(NPM)
	$(NODE) $(NPM) install -g $*

node: $(NPM) yarn.js pnpm.js pnpm.nvmshim pnpx.nvmshim


# Python
PYENV_ROOT = $(HOME)/.pyenv
PYENV = $(PYENV_ROOT)/bin/pyenv
$(PYENV):
	git -C $(PYENV_ROOT) pull || git clone https://github.com/pyenv/pyenv $(PYENV_ROOT)

PYENV_PLUGIN = $(PYENV_ROOT)/plugins/$(shell basename $@)
pyenv-%: $(PYENV)
	git -C $(PYENV_PLUGIN) pull || git clone https://github.com/$@ $(PYENV_PLUGIN)

pyenv: $(PYENV) pyenv/pyenv-ccache pyenv/pyenv-doctor pyenv/pyenv-installer \
	pyenv/pyenv-pip-migrate pyenv/pyenv-pip-rehash \
	massongit/pyenv-pip-update pyenv/pyenv-update pyenv/pyenv-virtualenv

PYTHON3_VERSION = 3.6.5
PYTHON3 = $(PYENV_ROOT)/versions/$(PYTHON3_VERSION)/bin/python
$(PYTHON3): pyenv
	$(PYENV) install -s $(PYTHON3_VERSION)
	$(PYENV) global $(PYTHON3_VERSION)

PIP3 = $(PYENV_ROOT)/versions/$(PYTHON3_VERSION)/bin/pip
$(PIP3): $(PYTHON3)

PYTHON2_VERSION = 2.7.14
PYTHON2 = $(PYENV_ROOT)/versions/$(PYTHON2_VERSION)/bin/python
$(PYTHON2): pyenv
	$(PYENV) install -s $(PYTHON2_VERSION)

PIP2 = $(PYENV_ROOT)/versions/$(PYTHON2_VERSION)/bin/pip
$(PIP2): $(PYTHON2)

PIPSI = $(HOME)/.local/bin/pipsi
$(PIPSI):
	curl http://git.io/get-pipsi -fsSL | $(PYTHON3) - --src=git+https://github.com/mitsuhiko/pipsi.git

%.py: $(PIPSI)
	$(PIPSI) install $* || $(PIPSI) upgrade $*

python: $(PIP2) $(PIP3) $(PIPSI) pylint.py flake8.py mypy.py pipenv.py


# Ruby
RBENV_ROOT = $(HOME)/.rbenv
RBENV = $(RBENV_ROOT)/bin/rbenv
$(RBENV):
	git -C $(RBENV_ROOT) pull || git clone https://github.com/rbenv/rbenv $(RBENV_ROOT)
	git -C $(RBENV_ROOT)/plugins/ruby-build pull || git clone https://github.com/rbenv/ruby-build $(RBENV_ROOT)/plugins/ruby-build

RBENV_PLUGIN = $(RBENV_ROOT)/plugins/$(shell basename $@)
rbenv-%: $(RBENV)
	git -C $(RBENV_PLUGIN) pull || git clone https://github.com/$@ $(RBENV_PLUGIN)

rbenv: $(RBENV) ianheggie/rbenv-binstubs yyuu/rbenv-ccache \
	tpope/rbenv-communal-gems tpope/rbenv-ctags rbenv/rbenv-each \
	rbenv/rbenv-installer rkh/rbenv-update mislav/rbenv-user-gems

RUBY_VERSION = 2.5.1
RUBY = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/ruby
$(RUBY): rbenv
	$(RBENV) install -s $(RUBY_VERSION)
	$(RBENV) global $(RUBY_VERSION)

GEM = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/gem
$(GEM): $(RUBY)

%.gem: $(GEM)
	$(GEM) install $*
	$(RBENV) rehash

ruby: $(GEM) bundler.gem rubocop.gem reek.gem


# Rust
CARGO_ROOT = $(HOME)/.cargo
RUSTUP = $(CARGO_ROOT)/bin/rustup
$(RUSTUP):
	curl https://sh.rustup.rs -fsSL | sh -s -- -y --no-modify-path --default-toolchain nightly
	$(RUSTUP) component add rustfmt-preview rls-preview

CARGO = $(CARGO_ROOT)/bin/cargo
$(CARGO): $(RUSTUP)

%.rs: $(CARGO)
	$(CARGO) install-update $* || $(CARGO) install $*

rust: $(CARGO) cargo-update.rs cargo-watch.rs clippy.rs


#
# Tools
#

# fish (fisherman)
FISH_CONFIG = $(HOME)/.config/fish
FISHER = $(FISH_CONFIG)/functions/fisher.fish
$(FISHER):
	curl https://git.io/fisher -fsSLo $(FISHER)

%.fisher:
	fish -c "fisher $*"

fish: $(FISHER) oh-my-fish/plugin-bang-bang.fisher edc/bass.fisher \
	fisherman/fzf.fisher fisherman/nvm.fisher fisherman/pipenv.fisher \
	neersighted/pyenv@patch-1.fisher neersighted/rbenv@patch-1.fisher \
	oh-my-fish/plugin-sudope.fisher fisherman/z.fisher


# fzf
FZF_ROOT = $(HOME)/.fzf
FZF = $(FZF_ROOT)/bin/fzf
$(FZF):
	git -C $(FZF_ROOT) pull || git clone https://github.com/junegunn/fzf.git $(FZF_ROOT)
	$(FZF_ROOT)/install --bin

fzf: $(FZF)


# neovim (rplugin providers)
NEOVIMPY3_ROOT = $(PYENV_ROOT)/versions/neovim3
NEOVIMPY3 = $(NEOVIMPY3_ROOT)/bin/python
$(NEOVIMPY3): $(PYTHON3)
	test -e $(NEOVIMPY3) || $(PYENV) virtualenv $(PYTHON3_VERSION) neovim3
	$(NEOVIMPY3) -m pip install -U neovim

NEOVIMPY2_ROOT = $(PYENV_ROOT)/versions/neovim2
NEOVIMPY2 = $(NEOVIMPY2_ROOT)/bin/python
$(NEOVIMPY2): $(PYTHON2)
	test -e $(NEOVIMPY2) || $(PYENV) virtualenv $(PYTHON2_VERSION) neovim2
	$(NEOVIMPY2) -m pip install -U neovim

NEOVIM_CONFIG = $(HOME)/.config/nvim/local.vim
$(NEOVIM_CONFIG): $(NEOVIMPY2) $(NEOVIMPY3)
	echo "let g:python3_host_prog = '$(NEOVIMPY3)'" > $(NEOVIM_CONFIG)
	echo "let g:python_host_prog = '$(NEOVIMPY2)'" >> $(NEOVIM_CONFIG)

neovim: neovim.js neovim-node-host.nvmshim $(NEOVIMPY2) $(NEOVIMPY3) neovim.gem $(NEOVIM_CONFIG)


# ripgrep
ripgrep: ripgrep.rs
