#!/usr/bin/make -f

NVM_ROOT = $(HOME)/.nvm
NVM = $(NVM_ROOT)/nvm.sh

node: $(NVM)
$(NVM):
	-git clone https://github.com/creationix/nvm $(NVM_ROOT)

PYENV_ROOT = $(HOME)/.pyenv
PYENV = $(PYENV_ROOT)/bin/pyenv

python: $(PYENV)
$(PYENV):
	-git clone https://github.com/yyuu/pyenv $(PYENV_ROOT)
	-git clone https://github.com/pyenv/pyenv-ccache $(PYENV_ROOT)/plugins/pyenv-ccache
	-git clone https://github.com/pyenv/pyenv-doctor $(PYENV_ROOT)/plugins/pyenv-doctor
	-git clone https://github.com/pyenv/pyenv-installer $(PYENV_ROOT)/plugins/pyenv-installer
	-git clone https://github.com/pyenv/pyenv-pip-migrate $(PYENV_ROOT)/plugins/pyenv-pip-migrate
	-git clone https://github.com/pyenv/pyenv-pip-rehash $(PYENV_ROOT)/plugins/pyenv-pip-rehash
	-git clone https://github.com/massongit/pyenv-pip-update $(PYENV_ROOT)/plugins/pyenv-pip-update
	-git clone https://github.com/pyenv/pyenv-update $(PYENV_ROOT)/plugins/pyenv-update
	-git clone https://github.com/pyenv/pyenv-virtualenv $(PYENV_ROOT)/plugins/pyenv-virtualenv

PYTHON3_VERSION = 3.6.5
PYTHON2_VERSION = 2.7.14
PYTHON3 = $(PYENV_ROOT)/versions/$(PYTHON3_VERSION)/bin/python
PYTHON2 = $(PYENV_ROOT)/versions/$(PYTHON2_VERSION)/bin/python

$(PYTHON3): $(PYENV)
	$(PYENV) install -s $(PYTHON3_VERSION)
$(PYTHON2): $(PYENV)
	$(PYENV) install -s $(PYTHON2_VERSION)

RBENV_ROOT = $(HOME)/.rbenv
RBENV = $(RBENV_ROOT)/bin/rbenv

ruby: $(RBENV)
$(RBENV):
	-git clone https://github.com/rbenv/rbenv $(RBENV_ROOT)
	-git clone https://github.com/rbenv/ruby-build $(RBENV_ROOT)/plugins/ruby-build
	-git clone https://github.com/ianheggie/rbenv-binstubs $(RBENV_ROOT)/plugins/rbenv-binstubs
	-git clone https://github.com/yyuu/rbenv-ccache $(RBENV_ROOT)/plugins/rbenv-ccache
	-git clone https://github.com/tpope/rbenv-communal-gems $(RBENV_ROOT)/plugins/rbenv-communal-gems
	-git clone https://github.com/tpope/rbenv-ctags $(RBENV_ROOT)/plugins/rbenv-ctags
	-git clone https://github.com/rbenv/rbenv-each $(RBENV_ROOT)/plugins/rbenv-each
	-git clone https://github.com/rbenv/rbenv-installer $(RBENV_ROOT)/plugins/rbenv-installer
	-git clone https://github.com/rkh/rbenv-update $(RBENV_ROOT)/plugins/rbenv-update
	-git clone https://github.com/mislav/rbenv-user-gems $(RBENV_ROOT)/plugins/rbenv-user-gems

RUBY_VERSION = 2.5.1
RUBY = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/ruby
GEM = $(RBENV_ROOT)/versions/$(RUBY_VERSION)/bin/gem
$(RUBY) $(GEM): $(RBENV)
	$(RBENV) install -s $(RUBY_VERSION)


CARGO_ROOT = $(HOME)/.cargo
RUSTUP = $(CARGO_ROOT)/bin/rustup
CARGO = $(CARGO_ROOT)/bin/cargo

rust: $(RUSTUP)
$(RUSTUP) $(CARGO):
	curl https://sh.rustup.rs -fsSL | sh -s -- -y --no-modify-path --default-toolchain nightly
	$(RUSTUP) component add rustfmt-preview rls-preview

TOOLCHAINS = node python ruby rust

toolchains: $(TOOLCHAINS)


CLIPPY = $(CARGO_ROOT)/bin/cargo-clippy

clippy: $(CARGO) $(CLIPPY)
$(CLIPPY):
	$(CARGO) install --force clippy

FZF_ROOT = $(HOME)/.fzf
FZF = $(FZF_ROOT)/bin/fzf

fzf: $(FZF)
$(FZF):
	-git clone https://github.com/junegunn/fzf.git $(FZF_ROOT)
	$(FZF_ROOT)/install --bin

NEOVIM_CONFIG = $(HOME)/.config/nvim/local.vim
NEOVIM3 = $(PYENV_ROOT)/versions/neovim3/bin/python
NEOVIM2 = $(PYENV_ROOT)/versions/neovim2/bin/python

$(NEOVIM3): $(PYTHON3)
	-$(PYENV) virtualenv $(PYTHON3_VERSION) neovim3
$(NEOVIM2): $(PYTHON2)
	-$(PYENV) virtualenv $(PYTHON2_VERSION) neovim2

neovim: $(GEM) $(NEOVIM3) $(NEOVIM2) $(NEOVIM_CONFIG)
$(NEOVIM_CONFIG):
	$(GEM) install neovim && $(RBENV) rehash
	$(NEOVIM3) -m pip install neovim
	$(NEOVIM2) -m pip install neovim
	echo "let g:python3_host_prog = '$(NEOVIM3)'" > $(NEOVIM_CONFIG)
	echo "let g:python_host_prog = '$(NEOVIM2)'" >> $(NEOVIM_CONFIG)

RIPGREP = $(CARGO_ROOT)/bin/rg

ripgrep rg: $(CARGO) $(RIPGREP)
$(RIPGREP):
	$(CARGO) install --force ripgrep

TOOLS = clippy fzf ripgrep

tools: $(TOOLS)


ALL = $(TOOLS) $(TOOLCHAINS)
TARGETS = toolchains tools all

all: toolchains tools
help:
	@echo "TARGETS: $(TARGETS)"
	@echo "AVAILABLE TOOLCHAINS: $(TOOLCHAINS)"
	@echo "AVAILABLE TOOLS: $(TOOLS)"

.DEFAULT_GOAL := help
.PHONY: $(ALL) $(TARGETS) $(.DEFAULT_GOAL)
