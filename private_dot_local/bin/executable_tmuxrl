#!/bin/sh

set -ex

while [ "$#" -gt 0 ]; do
  case $1 in
    -o)
      op=open
      shift
      ;;
    -y)
      op=yank
      shift
      ;;
    -t)
      pane=${2:?missing value: $1}
      shift 2
      ;;
    -f)
      full=1
      shift
      ;;
    -*)
      echo "unknown option: $1" >&2
      exit 1
      ;;
    *)
      echo "unrecognized argument: $1" >&2
      exit 1
      ;;
  esac
done

op=${op:-print}
if [ "$op" != 'yank' ]; then
  multi=1
fi

# shellcheck disable=SC2086
tmux capture-pane -J ${full:+-S- -E-} ${pane:+-t $pane} -p | xurls | fzf-tmux $FZF_TMUX_DEFAULT_OPTS -- --tac ${multi:+--multi} -1 --prompt="$op: " | while read -r url; do
  case $op in
    open)
      $SHELL -c "open '$url'"
    ;;
    yank)
      echo "$url" | $SHELL -c "$(tmux display-message -p '#{copy-command}')"
    ;;
    print)
      echo "$url"
    ;;
  esac
done
