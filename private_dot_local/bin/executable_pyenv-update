#!/usr/bin/fish

set_color yellow
echo "Updating pyenv..."
set_color normal

for repo in $RBENV_ROOT $RBENV_ROOT/plugins/*
  git -C $repo pull -q
end

set_color yellow
echo "Updating Poetry..."
set_color normal

poetry self update

set_color yellow
echo "Updating pipx venvs..."
set_color normal

pipx upgrade-all

set_color yellow
echo "Updating packages..."
set_color normal

for python in (pyenv versions --bare --skip-aliases)
  for spec in (PYENV_VERSION=$python python -m pip list --outdated --format=json | jq -c '.[]')
    set name (jq --argjson spec $spec -nr '$spec | "\(.name)"')
    set current (jq --argjson spec $spec -nr '$spec | "\(.version)"')
    set latest (jq --argjson spec $spec -nr '$spec | "\(.latest_version)"')

    set_color yellow
    echo "Updating $name from $current to $latest (Python $python)..."
    set_color normal

    PYENV_VERSION=$python python -m pip install -U $name
  end
end
